# Summary Compressor 设计文档

## 概述

`summary_compressor.py` 是 HearSight 项目中的检索结果信息压缩器，负责将冗长的检索结果压缩为关键信息，避免 ReAct 推理过程中的记忆爆炸问题。该模块采用层次化内容组织策略，支持单文件和多文件检索结果的智能压缩。

## 核心功能

### 1. 层次化内容组织

#### 设计理念
参考 `chat_prompt_service.py` 的组织策略，采用层次化标签系统来清晰地组织检索内容：

```
[文件开始: example_video.mp4]
  [块开始: 1 - 索引: 0-2]
  [0.00-3.50] 句子1
  [3.50-8.20] 句子2
  [块结束: 1]

  [块开始: 2 - 索引: 5-7]
  [25.00-28.50] 句子5
  [28.50-32.10] 句子6
  [块结束: 2]
[文件结束: example_video.mp4]

请注意：以上内容来自同一视频的不同块，不保证时间连续性。
```

#### 块分组逻辑
- **连续性判断**：按句子索引的连续性将检索结果分组为块
- **索引范围标识**：每个块标注包含的句子索引范围（如 `索引: 0-2`）
- **时间戳保留**：保持原始的时间戳信息，格式为 `[开始时间-结束时间]`

### 2. 多文件处理策略

#### 文件分类组织
当处理多个文件的检索结果时，系统会：
1. 为每个文件单独构建层次化内容结构
2. 生成文件概览，显示各文件的片段数量
3. 在压缩提示词中明确要求按文件分类总结

#### 示例输出格式
```
文件 video1.mp4:
主要讨论了人工智能技术[120.50-180.30]，强调了在医疗领域的应用价值。

文件 video2.mp4:
介绍了大数据分析方法[45.20-89.15]，展示了实际案例。
```

### 3. 智能压缩逻辑

#### 压缩触发条件
- **内容长度判断**：当原始内容超过 `max_length` 参数时触发压缩
- **直接返回策略**：内容较短时直接返回层次化组织的内容

#### LLM 压缩提示词
压缩提示词包含以下关键要素：
1. **用户问题上下文**：明确告知 LLM 用户的查询意图
2. **检索结果概览**：提供文件和片段数量的统计信息
3. **层次化内容**：完整的检索内容，采用标签系统组织
4. **压缩要求**：详细的压缩指导和输出格式示例
5. **长度控制**：指定输出长度的上限

#### 压缩参数
- **temperature**: 0.3 - 保证压缩结果的稳定性和准确性
- **max_tokens**: 1500 - 为多文件压缩预留足够的输出空间

### 4. 错误处理机制

#### 异常恢复策略
当 LLM 压缩失败时，系统会：
1. 返回简化的文件概览信息
2. 显示各文件的片段数量统计
3. 避免因压缩失败导致整个检索流程中断

#### 向后兼容性
保留 `compress_retrieval_results` 方法作为别名，确保现有代码的兼容性。

## 方法接口

### compress_single_file_results
处理单个文件的检索结果压缩。

**参数**:
- `question`: 用户问题
- `retrieval_results`: 单个文件的检索结果字典
- `max_length`: 压缩后文本的最大长度（默认 2000）

**返回值**: 压缩后的关键信息字符串

### compress_multiple_files_results
处理多个文件的检索结果压缩。

**参数**:
- `question`: 用户问题
- `retrieval_results_list`: 多个检索结果字典的列表
- `max_length`: 压缩后文本的最大长度（默认 2000）

**返回值**: 按文件分类组织的压缩信息

### _build_hierarchical_content (私有方法)
构建单个文件的层次化内容结构。

**参数**:
- `segments`: 句子片段列表
- `filename`: 文件名

**返回值**: 层次化组织的内容字符串

## 设计优势

### 1. 内容组织清晰
- 层次化标签系统让内容结构一目了然
- 文件和块的边界清晰标识
- 时间连续性说明帮助用户理解内容来源

### 2. 压缩质量保证
- 基于用户问题的相关性筛选
- 保留关键时间戳信息
- 智能长度控制，避免信息过载

### 3. 扩展性良好
- 支持单文件和多文件统一处理
- 模块化设计便于功能扩展
- 错误处理机制保证系统稳定性

### 4. 与现有系统集成
- 复用 LLM 路由服务
- 兼容现有的检索工具接口
- 遵循项目的编码规范和架构模式

## 使用场景

### 1. ReAct 推理优化
在 ChatAgent 的多步推理过程中，当检索到大量内容时，使用压缩器避免上下文过长导致的性能问题和记忆限制。

### 2. 多视频问答
当用户的问题涉及多个视频内容时，压缩器能够智能地组织和压缩来自不同文件的信息，提供清晰的答案结构。

### 3. 内容摘要生成
可以将压缩器作为独立的工具，为视频内容生成基于问题的智能摘要。

## 未来优化方向

1. **压缩质量评估**：添加压缩结果的质量评估机制
2. **缓存机制**：为相同问题和内容的压缩结果添加缓存
3. **并行处理**：支持多文件内容的并行压缩
4. **自定义压缩策略**：根据内容类型和问题类型选择不同的压缩算法