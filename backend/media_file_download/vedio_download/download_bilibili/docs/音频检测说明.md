# B站视频音频检测说明

## 概述

在 B站视频下载和处理过程中，经常需要检查视频文件是否包含音频轨道。本文档专门针对 B站视频的特点，介绍如何使用 FFmpeg 工具链来检测和分析视频文件的音频信息。

## B站视频格式特点

B站视频通常采用以下编码格式：
- **视频编码**：AV1 (Main profile)、H.264/AVC、H.265/HEVC
- **音频编码**：AAC (LC profile)、MP3
- **容器格式**：MP4 (m4v/m4a)
- **分辨率**：1080p、720p、480p 等
- **帧率**：30fps、24fps、25fps

## 使用 ffprobe 检查音频流

### 基本命令

```bash
ffprobe -i "B站视频文件.mp4" -show_streams -select_streams a
```

### 示例：有音频的输出

```text
[STREAM]
index=0
codec_name=aac
codec_long_name=AAC (Advanced Audio Coding)
profile=LC
codec_type=audio
codec_tag_string=mp4a
codec_tag=0x6134706d
sample_fmt=fltp
sample_rate=44100
channels=2
channel_layout=stereo
bits_per_sample=0
initial_padding=0
id=0x1
r_frame_rate=0/0
avg_frame_rate=0/0
time_base=1/44100
start_pts=0
start_time=0.000000
duration_ts=2027520
duration=45.975510
bit_rate=127999
max_bit_rate=N/A
bits_per_raw_sample=N/A
nb_frames=1980
nb_read_frames=N/A
nb_read_packets=N/A
extradata_size=2
DISPOSITION:default=1
DISPOSITION:dub=0
DISPOSITION:original=0
DISPOSITION:comment=0
DISPOSITION:lyrics=0
DISPOSITION:karaoke=0
DISPOSITION:forced=0
DISPOSITION:hearing_impaired=0
DISPOSITION:visual_impaired=0
DISPOSITION:clean_effects=0
DISPOSITION:attached_pic=0
DISPOSITION:timed_thumbnails=0
DISPOSITION:non_diegetic=0
DISPOSITION:captions=0
DISPOSITION:descriptions=0
DISPOSITION:metadata=0
DISPOSITION:dependent=0
DISPOSITION:still_image=0
DISPOSITION:multilayer=0
TAG:language=und
TAG:handler_name=SoundHandler
TAG:vendor_id=[0][0][0][0]
[/STREAM]
```

### 示例：无音频的输出（纯视频）

```text
Stream #0:0[0x1](und): Video: av1 (libdav1d) (Main) (av01 / 0x31307661), yuv420p(tv, bt709), 1920x1080, 788 kb/s, 30 fps, 30 tbr, 16k tbn (default)
    Metadata:
      handler_name    : Bento4 Video Handler
      vendor_id       : [0][0][0][0]
```

**视频流信息详细解释：**
- `Stream #0:0[0x1](und)`：第0个流的第0个子流，语言未定义(und)
- `Video: av1 (libdav1d) (Main)`：使用 AV1 编码，Main profile，libdav1d 解码器
- `(av01 / 0x31307661)`：AV1 的 fourcc 标识符
- `yuv420p(tv, bt709)`：YUV420P 色彩空间，BT.709 色域标准
- `1920x1080`：分辨率 1080p 全高清
- `788 kb/s`：视频平均比特率
- `30 fps`：30帧每秒
- `30 tbr`：时间基准帧率
- `16k tbn`：时间基准（16000单位/秒）
- `(default)`：这是默认流

### 音频流关键字段解释

- `codec_name=aac`：音频编码为 AAC
- `profile=LC`：Low Complexity profile（低复杂度配置）
- `sample_rate=44100`：44.1kHz 采样率（CD音质标准）
- `channels=2, channel_layout=stereo`：立体声，2声道
- `bit_rate=127999`：约128kbps 码率
- `duration=45.975510`：时长约46秒
- `DISPOSITION:default=1`：这是默认音频流

## 快速检测方法

### 检查是否有音频

```bash
# 返回音频流数量（0表示无音频）
ffprobe -i "视频.mp4" -show_streams -select_streams a -v quiet | grep -c "\[STREAM\]"
```

### 显示所有流信息

```bash
ffmpeg -i "视频.mp4"
```

## B站特有情况

1. **分P视频**：多集视频可能每集都有独立音频
2. **无音频视频**：某些演示视频可能只有画面
3. **多音频流**：极少数视频可能有多个语言音频
4. **DASH格式**：B站的 m4s 分片可能需要特殊处理
5. **AV1编码**：新视频可能使用AV1编码，需要相应解码器

## 下载后的音视频合并

### 下载流程中的合并

B站下载器会自动执行以下合并流程：

1. **分离下载**：使用 yt-dlp 将视频和音频分别下载为独立文件
   - 视频：MP4 文件（可能只含视频流）
   - 音频：M4A 文件（AAC 编码音频）

2. **自动合并**：检测到同时存在视频和音频时，使用 FFmpeg 合并

```bash
ffmpeg -i input_video.mp4 -i input_audio.m4a -c:v copy -c:a copy -map 0:v:0 -map 1:a:0 output.mp4
```

1. **输出结果**
   - 最终 MP4：包含视频和音频两个轨道
   - 备份 M4A：原始分离的音频文件

### 合并验证

合并后可使用以下命令验证结果文件是否包含音频：

```bash
ffprobe -v quiet -print_format json -show_streams "merged_video.mp4" | grep codec_type
```

如果输出中包含 `"codec_type": "audio"`，说明合并成功。

### 合并失败处理

如果合并失败，下载器会自动回退到仅保留视频文件的方案。此时输出包括：

- 纯视频 MP4 文件
- 分离的音频 M4A 文件

用户可以手动使用上述 FFmpeg 命令合并这两个文件。

