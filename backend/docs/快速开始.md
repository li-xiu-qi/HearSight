# HearSight 主后端快速开始指南

本文档介绍如何启动 HearSight 主后端服务。

## 🔥 获取源代码

```bash
git clone https://github.com/li-xiu-qi/HearSight
cd HearSight
```

## ⚙️ 环境配置

在 `backend/` 目录下创建 [.env](file:///c:/Users/ke/Downloads/HearSight/backend/.env) 文件，按需配置以下参数：

```bash
# PostgreSQL 数据库（必需）
POSTGRES_USER=hearsight
POSTGRES_PASSWORD=hearsight_pass
POSTGRES_DB=hearsight
POSTGRES_PORT=5432

# 服务端口（可选）
BACKEND_PORT=9999
FRONTEND_PORT=10000

# LLM 配置（必需，推荐使用百度AI Studio）
LLM_PROVIDER=openai
LLM_MODEL=ernie-4.5-300B-A47B
LLM_PROVIDER_BASE_URL=https://aistudio.baidu.com/llm/lmapi/v3
LLM_PROVIDER_API_KEY=your_ai_studio_api_key

# Embedding 配置（必需）
EMBEDDING_PROVIDER=openai
EMBEDDING_PROVIDER_BASE_URL=https://api.siliconflow.cn/v1
EMBEDDING_MODEL=BAAI/bge-m3
EMBEDDING_PROVIDER_API_KEY=your_siliconflow_api_key

# Bilibili（可选）
BILIBILI_SESSDATA=your_sessdata_here

# ASR Backend Service（可选，如果使用不同的 ASR 服务地址）
ASR_BACKEND_URL=http://localhost:8003
```

在 `ASRBackend/` 目录下也需要创建 [.env](file:///c:/Users/ke/Downloads/HearSight/backend/.env) 文件：

```bash
# ASR 相关配置
ASR_MODE=cloud
DASHSCOPE_API_KEY=your_dashscope_api_key
```

**快速提示**：项目推荐使用百度AI Studio的OpenAI兼容API作为LLM服务，可使用ernie-4.5-300B-A47B模型。配置AI_STUDIO_API_KEY（对应OpenAI SDK的api_key字段）和base_url="https://aistudio.baidu.com/llm/lmapi/v3"（对应OpenAI SDK的base_url字段）即可。更具体的内容可以参考：https://ai.baidu.com/ai-doc/AISTUDIO/rm344erns。Embedding服务默认使用硅基流动的OpenAI兼容API，平台地址：https://siliconflow.cn，免费额度申请：https://cloud.siliconflow.cn/i/FcjKykMn。

## 🧩 启动依赖服务

HearSight 后端依赖以下服务：
1. PostgreSQL 数据库
2. Redis 服务器
3. ASRBackend 服务（用于语音识别）

可以通过 Docker 一键启动这些依赖服务：

```bash
# 在项目根目录（HearSight/）下执行
docker-compose -f docker-compose.local.yml up -d postgres redis asr_backend
```

或者分别手动启动这些服务。

> 更多关于 ASRBackend 的配置和使用信息，请参考 [ASRBackend 相关文档](../../ASRBackend/docs/)：
> - [ASR 服务设计文档](../../ASRBackend/docs/ASR_服务设计文档.md)
> - [ASR 快速开始指南](../../ASRBackend/docs/快速开始.md)
> - [ASR 快速配置](../../ASRBackend/docs/快速配置.md)
> - [ASR API 文档](../../ASRBackend/docs/api.md)
> - [ASR Docker 部署](../../ASRBackend/docs/docker_deployment.md)
> - [ASR 设计说明](../../ASRBackend/docs/设计说明.md)

## 🐳 方案一：容器化部署（推荐）

### 使用项目根目录的 docker-compose 文件（推荐）

一行命令启动后端服务及相关依赖：

```bash
# 在项目根目录（HearSight/）下执行
docker-compose -f docker-compose.cloud.yml up -d --build
```

### 使用 backend 目录下的 docker-compose 文件

你也可以使用 backend 目录下专门为后端服务创建的统一 docker-compose 文件，但需要注意该文件不包含数据库和Redis服务，需要确保这些依赖服务已经运行：

```bash
# 在 backend/ 目录下执行，确保已启动 PostgreSQL、Redis 和 ASRBackend 服务
docker-compose -f docker-compose.yml up -d --build
```

部署完成后，访问 http://localhost:9999 即可进入后端服务。

> 如果仅需使用容器运行 PostgreSQL 数据库，而将后端在本地启动，请参考下方本地部署方案。

## 💻 方案二：本地开发部署

### 前置要求

需要 PostgreSQL 数据库和 Redis 服务器运行。可通过 Docker 启动也可本地安装。

### 后端服务启动

1. 安装依赖

   ```bash
   # 在项目根目录（HearSight/）下执行
   pip install -r requirements.txt
   ```

2. 启动服务

   ```bash
   # 在项目根目录（HearSight/）下执行
   python main.py
   ```

   后端运行在 `http://localhost:9999`

## 🧪 验证服务

打开浏览器访问 `http://localhost:9999/docs`，进入 Swagger 文档界面测试 API。

或使用命令行测试：

```bash
curl http://localhost:9999/health
```

健康检查应该返回类似以下的信息表示启动成功：
```json
{
  "status": "healthy",
  "timestamp": "2023-01-01T00:00:00"
}
```

## 🚩 常见问题

### 数据库连接失败
检查 [.env](file:///c:/Users/ke/Downloads/HearSight/backend/.env) 中的数据库配置是否正确，确保 PostgreSQL 服务正在运行。

### Redis 连接失败
检查 Redis 配置，默认使用 `redis://localhost:6379/0`，确保 Redis 服务正在运行。

### 端口被占用
修改启动命令中的端口号：
```bash
uvicorn main:app --host 0.0.0.0 --port 8000
```